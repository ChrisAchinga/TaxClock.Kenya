<html>
<head>

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="clock.css">

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta property="og:title" content="The 2016 Tax Clock" />
  <meta property="og:description" content="It’s easy to see how much of your salary is taken for taxes, but do you know how many hours are allocated to those deductions? Enter your salary to see how your tax money is being spent." />
  <meta property="og:image" content="https://static.code4sa.org/taxclock/preview.jpg" />
  <meta property="og:url" content="https://static.code4sa.org/taxclock/index.html?show-embed-link=true" />

  <title>The 2016 Tax Clock - Code4SA Data Journalism Academy</title>

</head>

<body>
  <div class="embed-link">
    <a href="embed.html" target="_blank">&lt;EMBED&gt;</a>
  </div>

  <div class="jumbotron">
    <div class="container">
      <h1>2016</h1>
      <h2>Tax Clock</h2>
      <h3><span class="h3-inner">​How much of your work day is spent paying taxes?​</span></h3>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <div class="explanation-wrapper">
          <div class="explanation">
            <strong>Did you know, you don’t just pay tax in Rands, but hours as well?</strong> Tax forms part of your total salary, which means that part of your 9-5 goes to government too. Enter your salary below to see how many hours you spend on government services and where your money may be going.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="calculator">
    <div class="container">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="input-wrapper">
            <div id="input">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-sm-4 col-xs-8 col-xs-offset-2 col-sm-offset-0 icon">
                    <img src="icon-income.png" class="img-responsive">
                  </div>
                  <div class="col-sm-8 col-xs-12">
                  <h4>What is your <strong>annual income*</strong> (before tax)?</h4>
                    <div class="input-group input-group-lg">
                      <span class="input-group-addon">R</span>
                      <input class="income form-control" type="text" name="income"  aria-label="Annual income before tax">
                    </div>
                  <h6>* This should be your income <i>before</i> tax but <i>after</i> deductions such as pension and medical aid.</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="output-wrapper">
            <div id="clock">
              <div id="output-clock">
                <h4 id="right-now">Right now</h4>
                <div id="clock-now"></div>
                <h4 id="working-on">You're working for:</h4>
                <div id="clock-item">?</div>
                <div id="clock-next-wrapper">
                  <h4>Next up:</h4>
                  <div id="clock-next"></div>
                </div>
              </div>
            </div>
            <div id="dayplanner">
              <h4>Your work schedule today would look like this:</h4>
              <div id="output-dayplanner"></div>
              <div id="calendar-download"><a href="javascript:cal.download()" class="btn btn-default">Install daily calendar (ICS)</a></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footnotes">
    <div class="container">
      <div class="col-md-6 col-md-offset-3">
        <h6>Approximations are based on VAT and personal income tax as per the 2016 budget. VAT has been assumed at a level of 14% of disposable income.</h6>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="container">
      <div class="credits">A project by <a href="http://academy.code4sa.org" target="_blank"><img src="logo_academy.png"></a></div>
      <div class="registrations">Code for South Africa is a non-profit organisation registered with the South African Department of Social Development.</div>
      <div class="license">Licensed under a Creative Commons Attribution 4.0 International License</div>
    </div>
  </div>
  <script src="jquery-1.12.0.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="moment.js"></script>
  <script src="income-calculator.js"></script>
  <script src="pym.js"></script>
  <script src="icsFormatter.js"></script>

  <script>
    var cal = null;
    function Slugify(str) {
      var $slug = '';
      var trimmed = $.trim(str);
      $slug = trimmed.replace(/[^a-z0-9-]/gi, '-').
      replace(/-+/g, '-').
      replace(/^-|-$/g, '');
      return $slug.toLowerCase();
    }

    function GetHours(mins) {
      var hours = Math.floor( mins / 60);
      return hours;
    }

    function GetMinutes(mins) {
      var minutes = Math.floor(mins % 60);
      return minutes;
    }

    function GetSeconds(mins) {
      var seconds = Math.floor((mins * 60) % 60);
      return seconds;
    }

    function workingOn(now, items, calc) {
      // of the items in items, what is being worked on now?
      var current = 0, next;

      // sort by end time
      items = _.sortBy(items, function(x) { return x.valueOf(); });

      for (var i = 0; i < items.length; i++) {
        if (now.isBefore(items[i].finish_time)) {
          current = i;
          break;
        }
      }

      if (current < items.length) {
        next = items[current+1];
      }
      current = items[current];

      if (now.isBefore(calc.START_OF_DAY) || now.isAfter(calc.END_OF_DAY)) {
        next = current;
        current = null;
      }

      return [current, next];
    }

    function checkEmbedLink() {
      if (window.location.search.indexOf('embed-link') > -1) {
          allowEmbedLink();
      }
    }

    function allowEmbedLink() {
        $('.embed-link').addClass('allowed');
    }

    function createICS(breakdown) {
        var num_slots = breakdown.length;
        var secondlast_slot_start = breakdown[num_slots - 2].finish_time;
        var end_day = breakdown[num_slots - 1].finish_time;
        cal = icsFormatter();
        cal.addEvent('Working for yourself', 'Every minute from now on, you\'re working for yourself', 'Work', secondlast_slot_start, end_day, 'RRULE:FREQ=DAILY;INTERVAL=1');
                
        return cal;
    }

    if (window != window.top) {
      $('body').addClass('embedded');
    } else {
      $('body').addClass('standalone');
    }
    var pymChild;
    var engaged = false;

    $(function() {
      var firstLoop = true;
      var output;
      pymChild = new pym.Child({id: 'code4sa-embed-taxclock' });
      checkEmbedLink();
      $('.income').on('change keyup', function() {
        var income = parseFloat($(this).val());
        var calc = new IncomeCalculator();
        output = calc.calculateIncomeBreakdown(income);
        cal = createICS(output.breakdown);

        /* Clear output */
        $('#output-wrapper').hide();

        if (income > 0){
          $('#output-dayplanner').html('');
          var startTime = calc.START_OF_DAY.format('h:mm a');

          $(output.breakdown).each(function(){
            var breakdown = this;
            $(breakdown).each(function(){

              var name = this.name;
              var slug = Slugify(this.name);
              var finishtime = this.finish_time_s;
              var taxamount = this.taxpayer_amount;

              var mins = this.minutes;
              var hours = GetHours(mins);
              var minutes = GetMinutes(mins);
              var seconds = GetSeconds(mins);

              /* if minutes > 0 and seconds > 30, round up a 1 minute */
              if (minutes > 0 && seconds > 30) {
                minutes = minutes + 1;
                seconds = 0;
              }
              else if (minutes > 0) {
                seconds = 0;
              }

              var hoursString = "";
              var minutesString = "";
              var secondsString = "";

              if (hours > 0) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (hours == 1) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (minutes > 0) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minutes </span>';
              }

              if (minutes == 1) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minute </span>';
              }

              if (seconds > 0) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              if (seconds == 1) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              var startHour = startTime.substr(0, startTime.indexOf(':'));

              var durationDiv = '<div class="item-duration">' + hoursString + minutesString + secondsString + '</div>';

              var rowHeight = Math.floor(mins * 14);
              if (rowHeight > 450){ rowHeight = 450; }

              'Add a class for small items (under 5 minutes)'
              var smallClass = "";
              if (minutes < 5){ smallClass= " item-small"; }

              $('#output-dayplanner').append('<div class="item hour-' + startHour + smallClass + '" id="' + slug + '" style="min-height: ' + rowHeight + 'px;"><div class="item-starttime-wrapper"><span class="item-starttime">' + startTime + '</span></div><div class="item-details"><div class="item-name">' + name + '</div><div class="item-duration">' + durationDiv + "</div></div></div>");

              startTime = finishtime;
            });
          });

          $('#output-dayplanner').prepend('<div class="item" id="start"><strong>9am</strong> - Start of the workday</div>').append('<div class="item" id="end"><strong>5pm</strong> - End of the workday</div>');

          /* update clock */
          function tick() {
            var now = moment();
            $('#clock-now').text(now.format('h:mm a'));

            // current and next work items
            var pair = workingOn(now, output.breakdown, calc);

            if (pair[0]) {
              $('#clock-next-wrapper, #working-on').show();
              $('#clock-item').show().text(pair[0].name);
            } else {
              $('#clock-next-wrapper, #working-on').hide();
              $('#clock-item').text('Put your feet up, you deserve a break for your tax contributions.');
              // show morning message (after 4 am)
              var nowHour = parseInt(now.format('H'));
              if (nowHour >= 4 && nowHour < 9) {
                $('#clock-item').text('Brace yourself, you have a long day ahead of you.');
              }
            }

            $('#clock-next').text(pair[1] ? pair[1].name : 'End of the workday');
          };

          // update it now
          tick();

          if (firstLoop) {
            // update it every 1 second
            setInterval(tick, 1000);
            firstLoop = false;
          }

          /* Show the output */
          $('#output-wrapper').show();
          ga('send', 'event', 'taxclock', 'salary', $(this).val());

          if (!engaged) {
            ga('send', 'event', 'taxclock', 'engaged');
          }
          engaged = true;

          // tell pym to resize
          pymChild.sendHeight();
        } else {
          var footer = $('.footer');
          pymChild.sendMessage("childShrank", footer.offset().top+footer.height());
        }

      });
      /* Stupid hack to probably fix size once probably rendered initially */
      setInterval(function() { pymChild.sendHeight(); }, 1000);
    })
  </script>

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48399585-35', 'auto');
    ga('send', 'pageview');
  </script>

</body>

</html>
