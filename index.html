<html>
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>The 2016 Tax Clock - Code4SA Data Journalism Academy</title>

  <script src="jquery-1.12.0.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="moment.js"></script>
  <script src="income-calculator.js"></script>
  <script src="pym.js"></script>

  <script>

    function Slugify(str) {
      var $slug = '';
      var trimmed = $.trim(str);
      $slug = trimmed.replace(/[^a-z0-9-]/gi, '-').
      replace(/-+/g, '-').
      replace(/^-|-$/g, '');
      return $slug.toLowerCase();
    }

    function GetHours(mins) {
      var hours = Math.floor( mins / 60);
      return hours;         
    }

    function GetMinutes(mins) {      
      var minutes = Math.floor(mins % 60);
      return minutes;
    }

    function GetSeconds(mins) {      
      var seconds = Math.floor((mins * 60) % 60);
      return seconds;
    }

    function workingOn(now, items, calc) {
      // of the items in items, what is being worked on now?
      var current = 0, next;

      // sort by end time
      items = _.sortBy(items, function(x) { return x.valueOf(); });

      for (var i = 0; i < items.length; i++) {
        if (now.isBefore(items[i].finish_time)) {
          current = i;
          break;
        }
      }

      if (current < items.length) {
        next = items[current+1];
      }
      current = items[current];

      if (now.isBefore(calc.START_OF_DAY) || now.isAfter(calc.END_OF_DAY)) {
        next = current;
        current = null;
      }

      return [current, next];
    }

    $(function() {
      var firstLoop = true;
      var output;
      var pymChild = new pym.Child({id: 'code4sa-embed-taxclock'});

      $('.income').on('change keyup', function() {
        var income = parseFloat($(this).val());
        var calc = new IncomeCalculator();
        output = calc.calculateIncomeBreakdown(income);

        /* Clear output */
        $('#output-wrapper').hide();

        if (income > 0){
          $('#output-dayplanner').html('');
          var startTime = calc.START_OF_DAY.format('h:mm a');

          $(output.breakdown).each(function(){
            var breakdown = this;
            $(breakdown).each(function(){

              var name = this.name;
              var slug = Slugify(this.name);
              var finishtime = this.finish_time_s;
              var taxamount = this.taxpayer_amount;

              var mins = this.minutes;
              var hours = GetHours(mins);
              var minutes = GetMinutes(mins);
              var seconds = GetSeconds(mins);

              /* if minutes > 0 and seconds > 30, round up a 1 minute */
              if (minutes > 0 && seconds > 30) {
                minutes = minutes + 1;
                seconds = 0;
              }
              else if (minutes > 0) {
                seconds = 0;
              }

              var hoursString = "";
              var minutesString = "";
              var secondsString = "";

              if (hours > 0) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (hours == 1) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (minutes > 0) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minutes </span>';
              }

              if (minutes == 1) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minute </span>';
              }

              if (seconds > 0) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              if (seconds == 1) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              var startHour = startTime.substr(0, startTime.indexOf(':'));

              var durationDiv = '<div class="item-duration">' + hoursString + minutesString + secondsString + '</div>';       

              var rowHeight = Math.floor(mins * 14);
              if (rowHeight > 450){ rowHeight = 450; }

              'Add a class for small items (under 5 minutes)'
              var smallClass = "";
              if (minutes < 5){ smallClass= " item-small"; }

              $('#output-dayplanner').append('<div class="item hour-' + startHour + smallClass + '" id="' + slug + '" style="min-height: ' + rowHeight + 'px;"><div class="item-starttime-wrapper"><span class="item-starttime">' + startTime + '</span></div><div class="item-details"><div class="item-name">' + name + '</div><div class="item-duration">' + durationDiv + "</div></div></div>");

              startTime = finishtime;
            });
          });

          $('#output-dayplanner').prepend('<div class="item" id="start"><i class="fa fa-sun-o"></i> <strong>9am</strong> - Start of the workday</div>').append('<div class="item" id="end"><i class="fa fa-moon-o"></i> <strong>5pm</strong> - End of the workday</div>');

          /* update clock */
          function tick() {
            var now = moment();
            $('#clock-now').text(now.format('h:mm a'));

            // current and next work items
            var pair = workingOn(now, output.breakdown, calc);

            if (pair[0]) {
              $('#working-on').show();
              $('#clock-item').show().text(pair[0].name);
            } else {
              $('#clock-item, #working-on').hide();
            }

            $('#clock-next').text(pair[1] ? pair[1].name : 'End of the workday');
          };

          // update it now
          tick();

          if (firstLoop) {
            // update it every 1 second
            setInterval(tick, 1000);
            firstLoop = false;
          }

          /* Show the output */
          $('#output-wrapper').show();

          // tell pym to resize
          //pymChild.sendHeight();
        }

      });
    })
  </script>

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="clock.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

</head>

<body>

  <div class="jumbotron">
    <div class="container">
      <h1>2016</h1>
      <h2>Tax Clock</h2>
      <h3><span class="h3-inner">How much of your day is spent working for the State?</span></h3>
    </div>
  </div>

  <div class="calculator">
    <div class="container">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="input-wrapper">
            <div id="input">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-sm-4 col-xs-8 col-xs-offset-2 col-sm-offset-0 icon">
                    <img src="icon-income.png" class="img-responsive">
                  </div>
                  <div class="col-sm-8 col-xs-12">
                  <h4>What is your <strong>annual income</strong> (before tax)?</h4>
                    <div class="input-group input-group-lg">
                      <span class="input-group-addon">R</span>
                      <input class="income form-control" type="text" name="income"  aria-label="Annual income before tax">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="output-wrapper">
            <div class="explanation">
              <div class="container-fluid">
                <div class="row">
                  <div class="col-sm-4 col-xs-8 col-xs-offset-2 col-sm-offset-0 col-sm-push-8 icon">
                    <img src="icon-diary.png" class="img-responsive">
                  </div>
                  <div class="col-sm-8 col-xs-12  col-sm-pull-4">
                    <i>Imagine</i> you spend the beginning of your workday <strong>earning the money you'll pay towards tax</strong>, with the first few minutes going towards <i>government debts</i>, and the rest towards <i>government programmes from biggest to smallest</i>.
                  </div>
                </div>
              </div>
            </div>
            <div id="clock">
              <div id="output-clock">
                <h4 id="right-now">Right now</h4>
                <div id="clock-now"></div>
                <h4 id="working-on">You're working on:</h4>
                <div id="clock-item">?</div>
                <div id="clock-next-wrapper">
                  <h4>Next up:</h4>
                  <div id="clock-next"></div>
                </div>
              </div>
            </div>
            <div id="dayplanner">
              <h4>Your work schedule today would look like this:</h4>
              <div id="output-dayplanner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="footer">
  <div class="container">
    <div class="credits">A project by <a href="http://academy.code4sa.org" target="_blank"><img src="logo_academy.png"></a></div>
    <div class="registrations">Code for South Africa is a non-profit organisation registered with the South African Department of Social Development.</div>
    <div class="license">Licensed under a Creative Commons Attribution 4.0 International License</div>
  </div>
</div>

</body>

</html>
