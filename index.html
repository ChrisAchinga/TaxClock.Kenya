<html>
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="jquery-1.12.0.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="moment.js"></script>
  <script src="income-calculator.js"></script>

  <script>

    function Slugify(str) {
      var $slug = '';
      var trimmed = $.trim(str);
      $slug = trimmed.replace(/[^a-z0-9-]/gi, '-').
      replace(/-+/g, '-').
      replace(/^-|-$/g, '');
      return $slug.toLowerCase();
    }

    function GetHours(mins) {
      var hours = Math.floor( mins / 60);
      return hours;         
    }

    function GetMinutes(mins) {      
      var minutes = Math.floor(mins % 60);
      return minutes;
    }

    function GetSeconds(mins) {      
      var seconds = Math.floor((mins * 60) % 60);
      return seconds;
    }

    $(function() {

      $('.income').on('change keyup', function() {
        var income = parseFloat($(this).val());
        var calc = new IncomeCalculator();
        var output = calc.calculateIncomeBreakdown(income);

        /* Clear output */
        $('#output-wrapper').hide();

        if (income > 0){
          $('#output-dayplanner').html('');
          var startTime = '9:00 am';
          $(output.breakdown).each(function(){
            var breakdown = this;
            $(breakdown).each(function(){

              var name = this.name;
              var slug = Slugify(this.name);
              var finishtime = this.finish_time_s;
              var taxamount = this.taxpayer_amount;

              var mins = this.minutes;
              var hours = GetHours(mins);
              var minutes = GetMinutes(mins);
              var seconds = GetSeconds(mins);

              /* if minutes > 0 and seconds > 30, round up a 1 minute */
              if (minutes > 0 && seconds > 30) {
                minutes = minutes + 1;
                seconds = 0;
              }
              else if (minutes > 0) {
                seconds = 0;
              }

              var hoursString = "";
              var minutesString = "";
              var secondsString = "";

              if (hours > 0) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (minutes > 0) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minutes </span>';
              }

              if (seconds > 0) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              var startHour = startTime.substr(0, startTime.indexOf(':'));

              var durationDiv = '<div class="item-duration">' + hoursString + minutesString + secondsString + '</div>';       

              var rowHeight = Math.floor(mins * 14);
              if (rowHeight > 450){ rowHeight = 450; }

              'Add a class for small items (under 5 minutes)'
              var smallClass = "";
              if (minutes < 5){ smallClass= " item-small"; }

              $('#output-dayplanner').append('<div class="item hour-' + startHour + smallClass + '" id="' + slug + '" style="min-height: ' + rowHeight + 'px;"><div class="item-starttime-wrapper"><span class="item-starttime">' + startTime + '</span></div><div class="item-details"><div class="item-name">' + name + '</div><div class="item-duration">' + durationDiv + "</div></div></div>");

              startTime = finishtime;

            });
          });

          $('#output-dayplanner').prepend('<div class="item" id="start"><i class="fa fa-sun-o"></i> <strong>9am</strong> - Start of the workday</div>').append('<div class="item" id="end"><i class="fa fa-moon-o"></i> <strong>5pm</strong> - End of the workday</div>');

          /* function to format time */
          function formatAMPM(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            var ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = minutes < 10 ? '0'+minutes : minutes;
            var strTime = hours + ':' + minutes + ' ' + ampm;
            return strTime;
          }

          /* update clock */
          $(function(){
            setInterval(function(){

              var d=formatAMPM(new Date());
              var timeString=d.toString();
              $('#clock-now').html(timeString);

              timeHour = timeString.substr(0, timeString.indexOf(':'));
              timeMinutes = timeString.substr(2, timeString.indexOf(' ')-2);

            },1000);
          });           

          /* Show the output */
          $('#output-wrapper').show();
        }

      });
    })
  </script>

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="clock.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

</head>

<body>

  <div class="jumbotron">
    <div class="container">
      <h1>2016</h1>
      <h2>Tax Clock</h2>
      <h3><span class="h3-inner">How much of your day do you spend working for the government?</span></h3>
    </div>
  </div>

  <div class="calculator">
    <div class="container">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="input-wrapper">
            <div id="input">
              <h4><i class="fa fa-money fa-lg"></i> What is your annual income (before tax)?</h4>
              <div class="input-group input-group-lg">
                <span class="input-group-addon">R</span>
                <input class="income form-control" type="text" name="income"  aria-label="Annual income before tax">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="output-wrapper">
            <div class="explanation">
              <i>Imagine</i> you spent the beginning of your workday <strong>earning the money you'll pay towards tax</strong>, with the first few minutes going towards <i>government debts</i>, and the rest towards <i>government programmes from biggest to smallest</i>.
            </div>
            <div id="clock">
              <div id="output-clock">
                <h4>Right now</h4>
                <div id="clock-now"></div>
                <h4>Your working on:</h4>
                <div id="clock-item">?</div>
                <h4>Next up:</h4>
                <div id="clock-next">? (? mins)</div>
              </div>
            </div>
            <div id="dayplanner">
              <h4>Your work schedule today would look like this:</h4>
              <div id="output-dayplanner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>

</html>
