<html>
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="jquery-1.12.0.min.js"></script>
  <script src="underscore-min.js"></script>
  <script src="moment.js"></script>
  <script src="income-calculator.js"></script>

  <script>

    function Slugify(str) {
      var $slug = '';
      var trimmed = $.trim(str);
      $slug = trimmed.replace(/[^a-z0-9-]/gi, '-').
      replace(/-+/g, '-').
      replace(/^-|-$/g, '');
      return $slug.toLowerCase();
    }

    function GetHours(mins) {
      var hours = Math.floor( mins / 60);
      return hours;         
    }

    function GetMinutes(mins) {      
      var minutes = Math.floor(mins % 60);
      return minutes;
    }

    function GetSeconds(mins) {      
      var seconds = Math.floor((mins * 60) % 60);
      return seconds;
    }

    $(function() {
      $('.income').on('change keyup', function() {
        var income = parseFloat($(this).val());
        var calc = new IncomeCalculator();
        var output = calc.calculateIncomeBreakdown(income);

        /* Clear output */
        $('#output').html('<div class="item" id="instruction">Enter your annual income above</div>');

        if (income > 0){
          $('#output').html('');
          var startTime = '9:00 am';
          $(output.breakdown).each(function(){
            var breakdown = this;
            $(breakdown).each(function(){

              var name = this.name;
              var slug = Slugify(this.name);
              var finishtime = this.finish_time_s;
              var taxamount = this.taxpayer_amount;

              var mins = this.minutes;
              var hours = GetHours(mins);
              var minutes = GetMinutes(mins);
              var seconds = GetSeconds(mins);

              /* if minutes > 0 and seconds > 30, round up a 1 minute */
              if (minutes > 0 && seconds > 30) {
                minutes = minutes + 1;
                seconds = 0;
              }
              else if (minutes > 0) {
                seconds = 0;
              }

              var hoursString = "";
              var minutesString = "";
              var secondsString = "";

              if (hours > 0) {
                var hoursString = '<span class="item-hours">' + hours + ' hours </span>';
              }

              if (minutes > 0) {
                var minutesString = '<span class="item-minutes">' + minutes + ' minutes </span>';
              }

              if (seconds > 0) {
                var secondsString = '<span class="item-seconds">' + seconds + ' seconds</span>';
              }

              var startHour = startTime.substr(0, startTime.indexOf(':'));
              console.log(startHour);

              var durationDiv = '<div class="item-duration">' + hoursString + minutesString + secondsString + '</div>';       

              var rowHeight = Math.floor(mins * 16);
              if (rowHeight > 450){ rowHeight = 450; }

              $('#output').append('<div class="item hour-' + startHour +'" id="' + slug + '" style="min-height: ' + rowHeight + 'px;"><div class="item-starttime-wrapper"><span class="item-starttime">' + startTime + '</span></div><div class="item-details"><div class="item-name">' + name + '</div><div class="item-duration">' + durationDiv + "</div></div></div>");

              startTime = finishtime;

            });
          });

          $('#output').prepend('<div class="item" id="start"><i class="fa fa-sun-o"></i> <strong>9am</strong> - Start of the workday</div>').append('<div class="item" id="end"><i class="fa fa-moon-o"></i> <strong>5pm</strong> - End of the workday</div>');

        }

      });
    })
  </script>

  <!-- Main Stylesheet -->
  <link rel="stylesheet" href="clock.css">

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

</head>

<body>

  <div class="jumbotron">
    <div class="container">
      <h1>2016</h1>
      <h2>Tax Clock</h2>
      <h3><span class="h3-inner">How much of your day do you spend working for the government?</span></h3>
    </div>
  </div>

  <div class="calculator">
    <div class="container">
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="input-wrapper">
            <div id="input">
              <h4><i class="fa fa-money fa-lg"></i> What is your annual income (before tax)?</h4>
              <div class="input-group input-group-lg">
                <span class="input-group-addon">R</span>
                <input class="income form-control" type="text" name="income"  aria-label="Annual income before tax">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6 col-md-offset-3">
          <div id="output-wrapper">
            <div id="output">
              <div class="item" id="instruction">Enter your annual income above</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</body>

</html>
